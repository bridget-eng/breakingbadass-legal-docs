<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication Log - Breaking Badass Legal Docs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F7F3EF; }
        .text-primary { color: #5D654E; }
        .bg-primary { background-color: #5D654E; }
        .bg-secondary { background-color: #000000; }
        .text-accent { color: #ECCDC2; }
        .bg-accent { background-color: #ECCDC2; }
        .bg-sage { background-color: #C3CABC; }
        .border-primary { border-color: #5D654E; }
        .btn-primary { background-color: #5D654E; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #4a5540; }
        .btn-secondary { background-color: #000000; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #333333; }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .guidance-text { color: #666; font-style: italic; font-size: 0.875rem; margin-top: 0.5rem; }
        .warning-text { color: #d97706; font-size: 0.875rem; margin-top: 0.5rem; }
        .evidence-preview { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        .platform-badge { background-color: #e0e7ff; color: #3730a3; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .patternviewer-disclaimer { background-color: #dbeafe; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; }
        .court-guidance { background-color: #f0f9ff; border-left: 4px solid #3b82f6; padding: 1rem; margin: 1rem 0; }
        .neutral-checkbox { accent-color: #5D654E; }
    </style>
</head>
<body class="bg-warm-neutral">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">Communication Log</h1>
            <p class="text-gray-600">Document messages factually for court review and professional analysis</p>
        </div>

        <!-- PatternViewer Disclaimer -->
        <div class="patternviewer-disclaimer">
            <h3 class="font-semibold text-blue-800 mb-2">Documentation Focus</h3>
            <p class="text-sm text-blue-700 mb-2">
                This tool is for documentation only. For professional communication pattern analysis, we recommend <strong>PatternViewer</strong>.
            </p>
            <p class="text-sm text-blue-700">
                Need expert communication analysis? This app helps you document messages clearly for court. For professional pattern analysis, export your messages to PatternViewer.
            </p>
        </div>

        <!-- Court Guidance Box -->
        <div class="court-guidance">
            <h3 class="font-semibold text-blue-800 mb-2">Documentation Guidelines</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>• Preserve messages exactly as written - no paraphrasing</li>
                <li>• Use neutral, factual summaries only</li>
                <li>• Include date, time, and platform</li>
                <li>• Attach screenshots or original files</li>
                <li>• Focus on what was said, not interpretation</li>
            </ul>
        </div>

        <!-- Communication Entry Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-primary mb-4">New Communication Entry</h2>
            
            <form id="communicationForm">
                <!-- Date and Time -->
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Date *</label>
                        <input type="date" id="commDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Time *</label>
                        <input type="time" id="commTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>

                <!-- Platform -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Communication Platform *</label>
                    <select id="platform" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                        <option value="">Select platform</option>
                        <option value="text_message">Text Message</option>
                        <option value="email">Email</option>
                        <option value="talking_parents">TalkingParents</option>
                        <option value="our_family_wizard">Our Family Wizard (OFW)</option>
                        <option value="phone_call">Phone Call</option>
                        <option value="social_media">Social Media</option>
                        <option value="in_person">In Person</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Sender/Recipient -->
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">From *</label>
                        <input type="text" id="sender" placeholder="Who sent the message?" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">To *</label>
                        <input type="text" id="recipient" placeholder="Who received the message?" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>

                <!-- Message Content -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Message Content *</label>
                    <textarea id="messageContent" rows="6" placeholder="Paste or type the exact message content. Preserve original wording without interpretation." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required></textarea>
                    <p class="guidance-text">Preserve messages exactly as written. No paraphrasing or interpretation.</p>
                </div>

                <!-- Neutral Summary -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Neutral Summary *</label>
                    <textarea id="neutralSummary" rows="4" placeholder="Summarize what was communicated using neutral, factual language only." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required></textarea>
                    <p class="guidance-text">Use neutral, factual language. Avoid emotional or interpretive wording.</p>
                </div>

                <!-- Optional Court-Relevant Checkboxes -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-3">Court-Relevant Observations (Optional)</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="courtOrderRelevance" class="neutral-checkbox mr-2">
                            <span class="text-sm">Possible court order relevance</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="missedExchangeReference" class="neutral-checkbox mr-2">
                            <span class="text-sm">Possible missed exchange reference</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="refusalToProvideInfo" class="neutral-checkbox mr-2">
                            <span class="text-sm">Possible refusal to provide information</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="inappropriateTone" class="neutral-checkbox mr-2">
                            <span class="text-sm">Possible inappropriate tone (non-specific)</span>
                        </label>
                    </div>
                </div>

                <!-- Evidence Attachment -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-3">Evidence Attachment</h3>
                    <div class="evidence-preview">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Evidence Type</label>
                            <select id="evidenceType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">Select evidence type</option>
                                <option value="screenshot">Screenshot</option>
                                <option value="email_file">Email File</option>
                                <option value="text_export">Text Message Export</option>
                                <option value="audio_recording">Audio Recording</option>
                                <option value="document">Document</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Evidence Summary</label>
                            <textarea id="evidenceSummary" rows="3" placeholder="Brief description of what the evidence shows." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Upload Evidence File</label>
                            <input type="file" id="evidenceFile" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" accept="image/*,.pdf,.txt,.doc,.docx">
                            <p class="guidance-text">Upload screenshots, message exports, or other supporting files.</p>
                        </div>
                    </div>
                </div>

                <!-- Marking Options -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-3">Marking Options</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="marking" value="documentation" class="neutral-checkbox mr-2" checked>
                            <span class="text-sm">Documentation only</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="marking" value="external_review" class="neutral-checkbox mr-2">
                            <span class="text-sm">To be reviewed by external professional</span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4">
                    <button type="button" class="btn-secondary" onclick="saveDraft()">Save Draft</button>
                    <button type="submit" class="btn-primary">Add to Communication Log</button>
                </div>
            </form>
        </div>

        <!-- PatternViewer Export Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-primary mb-4">PatternViewer Export</h2>
            <p class="text-gray-600 mb-4">Export communications for professional pattern analysis</p>
            
            <div class="patternviewer-disclaimer">
                <p class="text-sm text-blue-700">
                    This export is designed for professional communication analysis. For expert pattern review, we recommend PatternViewer.
                </p>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <button class="btn-secondary" onclick="exportSelected('pdf')">Export as PDF</button>
                <button class="btn-secondary" onclick="exportSelected('zip')">Export as ZIP</button>
                <button class="btn-secondary" onclick="exportSelected('csv')">Export as CSV</button>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Context (Optional, Factual Only)</label>
                <textarea id="exportContext" rows="3" placeholder="Provide factual context for the exported communications." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
            </div>
        </div>

        <!-- Existing Communications List -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-primary mb-4">Communication History</h2>
            <div id="communicationsList" class="space-y-4">
                <!-- Communications will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Communication log functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadCommunications();
            
            // Form submission
            document.getElementById('communicationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addCommunication();
            });
        });

        function addCommunication() {
            const formData = {
                date: document.getElementById('commDate').value,
                time: document.getElementById('commTime').value,
                platform: document.getElementById('platform').value,
                sender: document.getElementById('sender').value,
                recipient: document.getElementById('recipient').value,
                messageContent: document.getElementById('messageContent').value,
                neutralSummary: document.getElementById('neutralSummary').value,
                evidenceType: document.getElementById('evidenceType').value,
                evidenceSummary: document.getElementById('evidenceSummary').value,
                courtOrderRelevance: document.getElementById('courtOrderRelevance').checked,
                missedExchangeReference: document.getElementById('missedExchangeReference').checked,
                refusalToProvideInfo: document.getElementById('refusalToProvideInfo').checked,
                inappropriateTone: document.getElementById('inappropriateTone').checked,
                marking: document.querySelector('input[name="marking"]:checked').value
            };

            // Send to server
            fetch('/api/communication', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Communication added successfully!');
                    document.getElementById('communicationForm').reset();
                    loadCommunications();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            });
        }

        function loadCommunications() {
            // Load existing communications from server
            fetch('/api/communications')
                .then(response => response.json())
                .then(communications => {
                    const container = document.getElementById('communicationsList');
                    container.innerHTML = '';
                    
                    communications.forEach(comm => {
                        const commElement = createCommunicationElement(comm);
                        container.appendChild(commElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading communications:', error);
                });
        }

        function createCommunicationElement(comm) {
            const div = document.createElement('div');
            div.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="platform-badge">${comm.platform}</span>
                        <span class="text-sm text-gray-500">${comm.date} at ${comm.time}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="editCommunication('${comm.id}')">Edit</button>
                        <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteCommunication('${comm.id}')">Delete</button>
                    </div>
                </div>
                <div class="mb-2">
                    <span class="text-sm font-medium">From:</span> ${comm.sender} → 
                    <span class="text-sm font-medium">To:</span> ${comm.recipient}
                </div>
                <div class="mb-2">
                    <p class="text-sm text-gray-700"><strong>Summary:</strong> ${comm.neutral_summary}</p>
                </div>
                ${comm.evidence_type ? `<div class="text-sm text-gray-600"><strong>Evidence:</strong> ${comm.evidence_type} - ${comm.evidence_summary}</div>` : ''}
                ${comm.court_order_relevance ? '<span class="violation-tag">Court Order Relevance</span>' : ''}
                ${comm.missed_exchange_reference ? '<span class="violation-tag">Missed Exchange</span>' : ''}
                ${comm.refusal_to_provide_info ? '<span class="violation-tag">Refused Info</span>' : ''}
                ${comm.inappropriate_tone ? '<span class="violation-tag">Inappropriate Tone</span>' : ''}
            `;
            
            return div;
        }

        function saveDraft() {
            // Save draft functionality
            const formData = Object.fromEntries(new FormData(document.getElementById('communicationForm')));
            localStorage.setItem('communicationDraft', JSON.stringify(formData));
            alert('Draft saved locally!');
        }

        function exportSelected(format) {
            // Export functionality for PatternViewer
            const selectedCommunications = Array.from(document.querySelectorAll('.communication-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedCommunications.length === 0) {
                alert('Please select communications to export.');
                return;
            }
            
            const context = document.getElementById('exportContext').value;
            
            fetch('/api/export-communications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    communications: selectedCommunications,
                    format: format,
                    context: context
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `communications_export.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            });
        }

        function editCommunication(id) {
            // Edit functionality
            alert('Edit feature coming soon!');
        }

        function deleteCommunication(id) {
            if (confirm('Are you sure you want to delete this communication?')) {
                fetch(`/api/communication/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadCommunications();
                    } else {
                        alert('Error deleting communication.');
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                });
            }
        }
    </script>
</body>
</html>
